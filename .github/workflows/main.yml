name: Build and Publish Plugin

# è§¦å‘å™¨ï¼šå½“ä»£ç è¢«æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
# ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨åˆ›å»ºæ–°ç‰ˆæœ¬ï¼ˆreleaseï¼‰æ—¶è§¦å‘
on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  build-and-publish-job: # åˆå¹¶åçš„ä»»åŠ¡åç§°
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu è™šæ‹Ÿæœºä¸Šè¿è¡Œ

    # æˆäºˆæ­¤ä»»åŠ¡è®¿é—® secrets å’Œ packages çš„æƒé™
    permissions:
      contents: write # This is the critical line
      packages: write
      
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® JDK ç¯å¢ƒ
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # æ­¥éª¤ 3: æˆäºˆ Gradle è„šæœ¬æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      # æ­¥éª¤ 4: æ„å»ºæ’ä»¶
      - name: Build plugin
        run: ./gradlew buildPlugin
     
      # æ­¥éª¤ 5: è·å–æ„å»ºäº§ç‰©è·¯å¾„
      - name: Get artifact path
        id: get-artifact-path
        run: echo "ARTIFACT_PATH=$(ls build/distributions/*.zip)" >> $GITHUB_ENV

      # æ­¥éª¤ 6: ä¸Šä¼  Release é™„ä»¶
      # è¿™ä¸ªæ­¥éª¤ä¼šåœ¨ GitHub Release ä¸­åˆ›å»ºæˆ–æ›´æ–°ä¸€ä¸ªé™„ä»¶
      - name: Upload plugin to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_PATH }}
          draft: false
          prerelease: false
          body_path: CHANGELOG.md
          token: ${{ secrets.GH_PACKAGE_TOKEN }} # ğŸ‘ˆ ä½¿ç”¨ä½ åˆ›å»ºçš„ Secret

          
      # æ­¥éª¤ 4: æ„å»ºå¹¶å‘å¸ƒæ’ä»¶åˆ° GitHub Packages
      # ç¯å¢ƒå˜é‡ GITHUB_TOKEN æ˜¯ç”¨äºèº«ä»½éªŒè¯çš„å…³é”®
      # - name: Build and Publish Plugin
      #   run: ./gradlew buildPlugin publish
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_PACKAGE_TOKEN }}
