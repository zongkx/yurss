name: Build and Publish Plugin

# 触发器：当代码被推送到 main 分支时触发
# 也可以选择在创建新版本（release）时触发
on:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  build-and-publish-job: # 合并后的任务名称
    runs-on: ubuntu-latest # 在最新的 Ubuntu 虚拟机上运行

    # 授予此任务访问 secrets 和 packages 的权限
    permissions:
      contents: read
      packages: write
      
    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤 2: 设置 JDK 环境
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 步骤 3: 授予 Gradle 脚本执行权限
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 步骤 4: 构建并发布插件到 GitHub Packages
      # 环境变量 GITHUB_TOKEN 是用于身份验证的关键
      - name: Build and Publish Plugin
        run: ./gradlew buildPlugin publish
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PACKAGE_TOKEN }}
